- name: Generate Services Manifest
  template:
    src: services.yml.j2
    dest: /opt/ceph_services.yml
    mode: 0700
- name: Generate Execution Script
  template:
    src: apply_services.sh.j2
    dest: /opt/ceph_apply_services.sh
    mode: 0700
- name: Run Execution Script
  ansible.builtin.command: /opt/ceph_apply_services.sh
  register: apply_out
- debug: var=apply_out.stdout_lines
- name: Remove Services Manifest
  ansible.builtin.file:
    path: /opt/ceph_services.yml
    state: absent
- name: Remove Execution Script
  ansible.builtin.file:
    path: /opt/ceph_apply_services.sh
    state: absent
- name: Check If Osd Service Exists
  ansible.builtin.shell: ceph orch ls | grep osd.all-available-devices
  register: osd_service_exists
- name: Set Osd Service
  ansible.builtin.command: ceph orch apply osd --all-available-devices
  register: set_osd_service
  when: '"osd.all-available-devices" not in osd_service_exists.stdout'
- debug: var=set_osd_service.stdout_lines
  when: '"osd.all-available-devices" not in osd_service_exists.stdout'