#!/bin/sh

set -e

#Control pool
ceph osd pool create {{ rgw_zone }}.rgw.control 32 32 replicated replicated_rule
ceph osd pool set {{ rgw_zone }}.rgw.control size 3
ceph osd pool set {{ rgw_zone }}.rgw.control min_size 2
ceph osd pool application enable {{ rgw_zone }}.rgw.control rgw

#Meta pool
ceph osd pool create {{ rgw_zone }}.rgw.meta 32 32 replicated replicated_rule
ceph osd pool set {{ rgw_zone }}.rgw.meta size 3
ceph osd pool set {{ rgw_zone }}.rgw.meta min_size 2
ceph osd pool application enable {{ rgw_zone }}.rgw.meta rgw

#Log pool
ceph osd pool create {{ rgw_zone }}.rgw.log 32 32 replicated replicated_rule
ceph osd pool set {{ rgw_zone }}.rgw.log size 3
ceph osd pool set {{ rgw_zone }}.rgw.log min_size 2
ceph osd pool application enable {{ rgw_zone }}.rgw.log rgw

#Otp pool
ceph osd pool create {{ rgw_zone }}.rgw.otp 32 32 replicated replicated_rule
ceph osd pool set {{ rgw_zone }}.rgw.otp size 3
ceph osd pool set {{ rgw_zone }}.rgw.otp min_size 2
ceph osd pool application enable {{ rgw_zone }}.rgw.otp rgw

#Default placement group index pool
ceph osd pool create {{ rgw_zone }}.rgw.buckets.index 64 64 replicated replicated_rule
ceph osd pool set {{ rgw_zone }}.rgw.buckets.index size 3
ceph osd pool set {{ rgw_zone }}.rgw.buckets.index min_size 2
ceph osd pool application enable {{ rgw_zone }}.rgw.buckets.index rgw

#Default placement group extra data pool
ceph osd pool create {{ rgw_zone }}.rgw.buckets.non-ec 64 64 replicated replicated_rule
ceph osd pool set {{ rgw_zone }}.rgw.buckets.non-ec size 3
ceph osd pool set {{ rgw_zone }}.rgw.buckets.non-ec min_size 2
ceph osd pool application enable {{ rgw_zone }}.rgw.buckets.non-ec rgw

#Default placement group standard storage class
ceph osd erasure-code-profile set {{ rgw_zone }}-ec k={{ default_erasure_code_k }} m={{ default_erasure_code_m }} crush-failure-domain=host
ceph osd pool create {{ rgw_zone }}.rgw.buckets.data 128 128 erasure {{ rgw_zone }}-ec
ceph osd pool set {{ rgw_zone }}.rgw.buckets.data min_size {{ default_erasure_code_k + 1 }}
ceph osd pool application enable {{ rgw_zone }}.rgw.buckets.data rgw

#Deploy gateways
ceph orch apply -i /opt/rgw_services.yml
sleep 30

#Create zone
radosgw-admin realm create --rgw-realm={{ rgw_zone }} --default
radosgw-admin zonegroup create --rgw-zonegroup={{ rgw_zone }} --rgw-realm={{ rgw_zone }} --master --default
radosgw-admin zone create --rgw-zonegroup={{ rgw_zone }} --rgw-zone={{ rgw_zone }} --master --default
{% if default_compression_algorithm is defined and default_compression_algorithm|length %}
radosgw-admin zone placement modify \
      --rgw-zone {{ rgw_zone }} \
      --placement-id default-placement \
      --storage-class STANDARD \
      --compression {{ default_compression_algorithm }}
{% endif %}

#Cleanup default zone
radosgw-admin zonegroup delete --rgw-zonegroup=default --rgw-zone=default
radosgw-admin period update --commit
radosgw-admin zone delete --rgw-zone=default
radosgw-admin period update --commit
ceph tell mon.* injectargs --mon_allow_pool_delete true
ceph osd pool rm default.rgw.log default.rgw.log --yes-i-really-really-mean-it
ceph osd pool rm default.rgw.control default.rgw.control --yes-i-really-really-mean-it
ceph osd pool rm default.rgw.meta default.rgw.meta --yes-i-really-really-mean-it
ceph tell mon.* injectargs --mon_allow_pool_delete false